{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block extrastyle %}
<style>
    :root {
        --primary-color: #4361ee;
        --primary-dark: #3651d4;
        --secondary-color: #6c757d;
        --light-bg: #f8f9fa;
        --border-color: #e1e5eb;
        --success-color: #198754;
        --error-color: #dc3545;
        --warning-color: #ffc107;
        --info-color: #0dcaf0;
    }

    * {
        box-sizing: border-box;
    }

    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    #content {
        padding: 40px 20px;
        max-width: 950px;
        margin: 0 auto;
    }

    .header {
        text-align: center;
        margin-bottom: 40px;
        background: rgba(255, 255, 255, 0.95);
        padding: 40px 30px;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
    }

    .header h1 {
        color: var(--primary-color);
        font-size: 2.2rem;
        margin-bottom: 8px;
        font-weight: 700;
        letter-spacing: -0.5px;
    }

    .header p {
        color: var(--secondary-color);
        font-size: 1.05rem;
        margin: 0;
        font-weight: 500;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
        perspective: 1000px;
    }

    .stat-box {
        background: white;
        padding: 25px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        border: 2px solid transparent;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: default;
        position: relative;
        overflow: hidden;
    }

    .stat-box::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color), var(--info-color));
    }

    .stat-box:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 25px rgba(67, 97, 238, 0.15);
        border-color: var(--primary-color);
    }

    .stat-number {
        font-size: 2.2rem;
        font-weight: 800;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 10px 0;
    }

    .stat-label {
        font-size: 0.95rem;
        color: var(--secondary-color);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .form-container {
        background: white;
        border-radius: 16px;
        padding: 40px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        margin-top: 30px;
    }

    .form-section {
        margin-bottom: 35px;
        padding-bottom: 30px;
        border-bottom: 1px solid var(--border-color);
    }

    .form-section:last-of-type {
        border-bottom: none;
        margin-bottom: 30px;
        padding-bottom: 0;
    }

    .form-section h3 {
        color: var(--primary-color);
        font-size: 1.25rem;
        margin-bottom: 20px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .form-section h3::before {
        content: '';
        width: 4px;
        height: 24px;
        background: linear-gradient(180deg, var(--primary-color), var(--primary-dark));
        border-radius: 2px;
    }

    .form-group {
        margin-bottom: 22px;
    }

    .form-group label {
        display: block;
        font-weight: 700;
        margin-bottom: 10px;
        color: #2c3e50;
        font-size: 1rem;
    }

    select, textarea, input[type="text"], input[type="file"] {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        background: white;
        transition: all 0.3s ease;
        font-family: inherit;
    }

    select:hover, textarea:hover, input:hover {
        border-color: var(--primary-color);
        background: #fafbfc;
    }

    select:focus, textarea:focus, input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15), inset 0 0 0 1px var(--primary-color);
    }

    textarea {
        min-height: 150px;
        resize: vertical;
        line-height: 1.6;
    }

    .help-text {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 8px;
        font-style: italic;
    }

    .char-counter {
        text-align: right;
        font-size: 0.85rem;
        color: var(--secondary-color);
        margin-top: 8px;
        font-weight: 600;
    }

    .char-counter.warning {
        color: var(--warning-color);
    }

    .char-counter.error {
        color: var(--error-color);
    }

    .submit-btn {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
        border: none;
        padding: 16px 40px;
        font-size: 1.05rem;
        border-radius: 8px;
        cursor: pointer;
        width: 100%;
        font-weight: 700;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        text-transform: uppercase;
    }

    .submit-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(67, 97, 238, 0.4);
    }

    .submit-btn:active:not(:disabled) {
        transform: translateY(0);
    }

    .submit-btn:disabled {
        background: #d3d3d3;
        cursor: not-allowed;
        opacity: 0.7;
    }

    .spinner {
        display: inline-block;
        width: 18px;
        height: 18px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        vertical-align: middle;
        margin-right: 10px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .custom-ids-group {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        padding: 20px;
        border-radius: 8px;
        margin-top: 12px;
        border-left: 4px solid var(--primary-color);
    }

    .custom-ids-group label {
        margin-bottom: 10px;
    }

    .result-box {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-top: 30px;
        border-left: 6px solid var(--primary-color);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        animation: slideInUp 0.4s ease;
    }

    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .result-box.success {
        border-left-color: var(--success-color);
        background: linear-gradient(135deg, #f0fdf4, #f1fde8);
    }

    .result-box.error {
        border-left-color: var(--error-color);
        background: linear-gradient(135deg, #fef2f2, #ffe8e8);
    }

    .result-box.processing {
        border-left-color: var(--warning-color);
        background: linear-gradient(135deg, #fffbf0, #ffe8d6);
    }

    .result-title {
        font-weight: 700;
        font-size: 1.15rem;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .result-content {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
    }

    .result-item {
        text-align: center;
        padding: 15px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
    }

    .result-number {
        font-size: 2rem;
        font-weight: 800;
        margin: 8px 0;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .result-label {
        font-size: 0.9rem;
        color: #666;
        font-weight: 600;
    }

    input[type="file"]::file-selector-button {
        padding: 8px 16px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    input[type="file"]::file-selector-button:hover {
        background: var(--primary-dark);
    }

    .send-preview {
        background: linear-gradient(135deg, #e7f3ff, #f0e7ff);
        border: 2px solid var(--primary-color);
        border-radius: 12px;
        padding: 20px;
        margin: 20px 0;
        display: none;
        animation: slideInDown 0.3s ease;
    }

    .send-preview.show {
        display: block;
    }

    @keyframes slideInDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .preview-title {
        font-weight: 700;
        font-size: 1.1rem;
        color: var(--primary-color);
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .preview-items {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
    }

    .preview-item {
        background: white;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid var(--primary-color);
        font-size: 0.95rem;
    }

    .preview-label {
        font-weight: 600;
        color: #555;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
    }

    .preview-value {
        color: var(--primary-color);
        font-weight: 700;
        font-size: 1.1rem;
    }

    .confirm-button-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .confirm-btn, .cancel-btn {
        flex: 1;
        padding: 12px 20px;
        border: 2px solid var(--primary-color);
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .confirm-btn {
        background: var(--primary-color);
        color: white;
    }

    .confirm-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
    }

    .cancel-btn {
        background: white;
        color: var(--primary-color);
    }

    .cancel-btn:hover {
        background: #f0f0f0;
    }


    @media (max-width: 768px) {
        #content {
            padding: 20px 15px;
        }

        .header {
            padding: 30px 20px;
        }

        .header h1 {
            font-size: 1.7rem;
        }

        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .form-container {
            padding: 25px;
        }

        .result-content {
            grid-template-columns: 1fr;
        }

        .stat-box {
            padding: 20px 15px;
        }

        .stat-number {
            font-size: 1.8rem;
        }
    }

    @media (max-width: 480px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }

        .header h1 {
            font-size: 1.5rem;
        }

        .submit-btn {
            font-size: 0.95rem;
            padding: 14px 30px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div id="content">
    <div class="header">
        <h1>üì® Telegram Xabar Yuborish</h1>
        <p>Barcha foydalanuvchilarga xabar yuborish</p>
    </div>

    <div class="stats-grid">
        <div class="stat-box">
            <div class="stat-number">{{ total_users }}</div>
            <div class="stat-label">Jami Foydalanuvchilar</div>
        </div>
        <div class="stat-box">
            <div class="stat-number">{{ total_drivers }}</div>
            <div class="stat-label">Haydovchilar</div>
        </div>
        <div class="stat-box">
            <div class="stat-number">{{ total_passengers }}</div>
            <div class="stat-label">Yo'lovchilar</div>
        </div>
        <div class="stat-box">
            <div class="stat-number">{{ total_banned }}</div>
            <div class="stat-label">Bloklanganlar</div>
        </div>
    </div>

    {% if message_result %}
        {% if message_result.status == 'completed' %}
            <div class="result-box success">
                <div class="result-title">‚úÖ Xabar jo'natish muvaffaqiyatli yakunlandi</div>
                <div class="result-content">
                    <div class="result-item">
                        <div class="result-label">Jo'natilgan</div>
                        <div class="result-number" style="color: var(--success-color);">{{ message_result.success }}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Xato</div>
                        <div class="result-number" style="color: var(--error-color);">{{ message_result.failed }}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Blok/Fake</div>
                        <div class="result-number" style="color: #ff9800;">{{ message_result.blocked }}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Jami</div>
                        <div class="result-number">{{ message_result.total }}</div>
                    </div>
                </div>
            </div>
        {% elif message_result.status == 'error' %}
            <div class="result-box error">
                <div class="result-title">‚ùå Xatolik yuz berdi</div>
                <p style="color: var(--error-color);">{{ message_result.error }}</p>
            </div>
        {% elif message_result.status == 'processing' %}
            <div class="result-box processing">
                <div class="result-title">‚è≥ Xabar jo'natilmoqda...</div>
                <div id="processingInfo" style="margin-top: 15px;">
                    <p style="margin: 10px 0; font-weight: 600; color: #333;">
                        üìç <strong id="recipientInfo"></strong>
                    </p>
                    <p style="margin: 10px 0; color: #666; font-size: 0.95rem;">
                        Iltimos, vaqt soting. Xabarlar jo'natilmoqda...
                    </p>
                    <div style="margin-top: 15px;">
                        <div style="background: rgba(255,255,255,0.7); padding: 10px; border-radius: 6px; border-left: 3px solid var(--warning-color);">
                            <span id="processingDetails" style="font-size: 0.9rem; color: #555;"></span>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    {% endif %}

    <div class="form-container">
        <form method="post" id="messageForm" enctype="multipart/form-data">
            {% csrf_token %}

            <div id="sendPreview" class="send-preview">
                <div class="preview-title">üìã Xabar jo'natish ma'lumotlari</div>
                <div class="preview-items">
                    <div class="preview-item">
                        <div class="preview-label">üë• Poydalanuvchilar</div>
                        <div class="preview-value" id="previewRecipients">-</div>
                    </div>
                    <div class="preview-item">
                        <div class="preview-label">üìù Xabar turi</div>
                        <div class="preview-value" id="previewMediaType">Matn</div>
                    </div>
                    <div class="preview-item">
                        <div class="preview-label">üî§ Format</div>
                        <div class="preview-value" id="previewFormat">-</div>
                    </div>
                </div>
                <div class="confirm-button-group">
                    <button type="button" class="confirm-btn" id="confirmBtn">‚úÖ Xabarni Yuborish</button>
                    <button type="button" class="cancel-btn" id="cancelBtn">‚ùå Bekor qilish</button>
                </div>
            </div>

            <div class="form-section">
                <h3>Kimga yuborilsin?</h3>
                <div class="form-group">
                    <label for="id_message_type">{{ form.message_type.label }}</label>
                    {{ form.message_type }}
                </div>

                <div id="customIdsGroup" class="custom-ids-group" style="display: none;">
                    <label for="id_custom_ids">{{ form.custom_ids.label }}</label>
                    {{ form.custom_ids }}
                    <div class="help-text">{{ form.custom_ids.help_text }}</div>
                </div>
            </div>

            <div class="form-section">
                <h3>Xabar matni</h3>
                <div class="form-group">
                    <label for="id_message">{{ form.message.label }}</label>
                    {{ form.message }}
                    <div class="char-counter">
                        <span id="charCount">0</span> / 4096 belgi
                    </div>
                    <div class="help-text">{{ form.message.help_text }}</div>
                </div>
            </div>

            <div class="form-section">
                <h3>Matn formati</h3>
                <div class="form-group">
                    <label for="id_parse_mode">{{ form.parse_mode.label }}</label>
                    {{ form.parse_mode }}
                    <div class="help-text">Xabarning formatini tanlang</div>
                </div>
            </div>

            <div class="form-section">
                <h3>Media yuborish (ixtiyoriy)</h3>
                <div class="form-group">
                    <label for="id_media_type">{{ form.media_type.label }}</label>
                    {{ form.media_type }}
                    <div class="help-text">Rasm, video, audio yoki fayl yuborish mumkin</div>
                </div>

                <div id="mediaFileGroup" class="form-group" style="display: none;">
                    <label for="id_media_file">{{ form.media_file.label }}</label>
                    {{ form.media_file }}
                    <div class="help-text" id="mediaHelp"></div>
                </div>
            </div>

            <button type="submit" class="submit-btn" id="submitBtn">
                <span id="btnText">üì® Xabarni Yuborish</span>
                <span id="btnSpinner" style="display: none;">
                    <span class="spinner"></span> Yuborilmoqda...
                </span>
            </button>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const messageType = document.getElementById('id_message_type');
    const customIdsGroup = document.getElementById('customIdsGroup');
    const messageTextarea = document.getElementById('id_message');
    const charCount = document.getElementById('charCount');
    const submitBtn = document.getElementById('submitBtn');
    const btnText = document.getElementById('btnText');
    const btnSpinner = document.getElementById('btnSpinner');
    const mediaType = document.getElementById('id_media_type');
    const mediaFileGroup = document.getElementById('mediaFileGroup');
    const mediaFileInput = document.getElementById('id_media_file');
    const mediaHelp = document.getElementById('mediaHelp');

    // Media help texti
    const mediaHelpTexts = {
        'photo': 'JPG, PNG formati, maksimum 5MB',
        'video': 'MP4, MOV formati, maksimum 50MB',
        'audio': 'MP3, OGG formati, maksimum 50MB',
        'document': 'Har qanday fayl, maksimum 50MB',
    };

    // Custom IDs guruhini ko'rsatish
    function toggleCustomIds() {
        customIdsGroup.style.display = messageType.value === 'custom' ? 'block' : 'none';
    }

    messageType.addEventListener('change', toggleCustomIds);
    toggleCustomIds();

    // Media tanlangan bo'lsa fayl guruhi ko'rsatish
    function toggleMediaFile() {
        const isMedia = mediaType.value !== 'none';
        mediaFileGroup.style.display = isMedia ? 'block' : 'none';
        
        if (isMedia) {
            mediaFileInput.setAttribute('accept', getMediaAccept(mediaType.value));
            mediaHelp.textContent = mediaHelpTexts[mediaType.value] || '';
            mediaFileInput.required = true;
        } else {
            mediaFileInput.removeAttribute('accept');
            mediaFileInput.required = false;
            mediaFileInput.value = '';
        }
    }

    function getMediaAccept(type) {
        const accepts = {
            'photo': 'image/jpeg,image/png',
            'video': 'video/mp4,video/quicktime',
            'audio': 'audio/mpeg,audio/ogg,audio/mp3',
            'document': '*/*',
        };
        return accepts[type] || '';
    }

    mediaType.addEventListener('change', toggleMediaFile);
    toggleMediaFile();

    // Belgilar sonini hisoblash
    function updateCharCount() {
        const count = messageTextarea.value.length;
        charCount.parentElement.classList.remove('warning', 'error');
        charCount.textContent = count;
        
        if (count > 4096) {
            charCount.parentElement.classList.add('error');
        } else if (count > 3500) {
            charCount.parentElement.classList.add('warning');
        }
    }

    messageTextarea.addEventListener('input', updateCharCount);
    updateCharCount();

    // Recipient types
    const recipientLabels = {
        'all': 'üåç Barcha foydalanuvchilar',
        'users': 'üë• Yo\'lovchilar',
        'drivers': 'üöó Haydovchilar',
        'banned': 'üö´ Bloklanganlar',
        'custom': 'üìå Maxsus ro\'yxat'
    };

    // Xabar turi labels
    const mediaLabels = {
        'none': 'üìù Matn xabar',
        'photo': 'üì∏ Rasm',
        'video': 'üé• Video',
        'audio': 'üéµ Audio',
        'document': 'üìÑ Fayl'
    };

    // Preview yangilash
    function updatePreview() {
        const recipients = recipientLabels[messageType.value] || '-';
        const media = mediaLabels[mediaType.value] || '-';
        const format = document.getElementById('id_parse_mode').value || 'Oddiy';

        document.getElementById('previewRecipients').textContent = recipients;
        document.getElementById('previewMediaType').textContent = media;
        document.getElementById('previewFormat').textContent = format;
    }

    // Form yuborish - preview ko'rsatish
    document.getElementById('messageForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const message = messageTextarea.value.trim();
        const mediaTypeValue = mediaType.value;
        const sendPreview = document.getElementById('sendPreview');

        if (!message) {
            alert('Iltimos, xabar matnini kiriting!');
            return;
        }

        if (message.length > 4096) {
            alert('Xabar 4096 belgidan oshmasligi kerak!');
            return;
        }

        if (mediaTypeValue !== 'none' && !mediaFileInput.files.length) {
            alert('Iltimos, media faylni tanlang!');
            return;
        }

        // Preview ko'rsatish
        updatePreview();
        sendPreview.classList.add('show');
        
        // Scroll to preview
        sendPreview.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    // Confirm button
    document.getElementById('confirmBtn').addEventListener('click', function() {
        const submitBtn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const btnSpinner = document.getElementById('btnSpinner');
        
        // Actual form submit
        btnText.style.display = 'none';
        btnSpinner.style.display = 'inline';
        submitBtn.disabled = true;
        
        // Form ni haqiqatan submit qilish
        document.getElementById('messageForm').submit();
    });

    // Cancel button
    document.getElementById('cancelBtn').addEventListener('click', function() {
        const sendPreview = document.getElementById('sendPreview');
        sendPreview.classList.remove('show');
        
        // Scroll back to form
        document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    // Form field changes
    messageType.addEventListener('change', updatePreview);
    mediaType.addEventListener('change', updatePreview);
    document.getElementById('id_parse_mode').addEventListener('change', updatePreview);
});
</script>
{% endblock %}